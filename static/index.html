<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>채팅</title>
    <link rel="stylesheet" href="/css/index.css" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/index.js"></script>
    <style>
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="main">
      <div id="loginContainer" class="login-container">
        <form id="loginForm">
          <input type="text" id="studentId" placeholder="Student ID" required />
          <input
            type="password"
            id="password"
            placeholder="Password"
            required
          />
          <button type="submit">Login</button>
        </form>
      </div>
      <div id="chat" class="chat">
        <!-- 채팅 메시지 영역 -->
      </div>
      <div id="messageContainer" class="login-container hidden">
        <input type="text" id="test" placeholder="메시지를 입력해주세요.."/>
        <button onclick="send()">전송</button>
        <button onclick="logout()" class="logout hidden">Logout</button>
      </div>
    </div>
  </body>
  <script>
    const socket = io()

    // 이전 채팅 메시지 불러오기
    fetch('/messages')
      .then(response => response.json())
      // .then(messages => {
      //   const chatContainer = document.getElementById('chat');
      //   messages.forEach(message => {
      //     const messageElement = document.createElement('div');
      //     messageElement.textContent = `${message.userId}: ${message.content}`;
      //     chatContainer.appendChild(messageElement);
      //   });
      // });
    
    $('form').submit(function(e) {
      e.preventDefault(); // 페이지 새로고침 방지
      socket.emit('chat message', $('#input').val());
      $('#input').val('');
      return false;
    });
    
    socket.on('chat message', function(msg) {
      $('#messages').append($('<li>').text(msg.userId + ': ' + msg.content));
    });

    document.getElementById("loginForm").addEventListener("submit", function (e) {
      localStorage.setItem('authToken', '1234');
      e.preventDefault();
      var studentId = document.getElementById("studentId").value;
      var password = document.getElementById("password").value;
      const authToken = localStorage.getItem('authToken');

      fetch("http://localhost:4000/user/lms", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${authToken}`,
        },
        body: JSON.stringify({
          studentId: studentId,
          password: password,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.accessToken) {
            // 인증 토큰을 localStorage에 저장
            localStorage.setItem('authToken', data.accessToken);

            // 로그인 성공 시 

            //메시지 입력창을 보여주고 로그인 폼을 숨김
            document.getElementById("loginContainer").classList.add("hidden");
            document
              .getElementById("messageContainer")
              .classList.remove("hidden");
            document.getElementById("chat").classList.remove("hidden");
            document
              .querySelector(".logout")
              .classList.remove("hidden");
          } else {
            // 로그인 실패 시 에러 메시지 표시
            alert(data.message || "로그인 실패");
          }
        })
        .catch((error) => console.error("Error:", error));
      });
    function logout() {
      // 로그아웃 로직을 여기에 구현하세요.
      const authToken = localStorage.getItem('authToken');
      fetch("http://localhost:4000/user/logout", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${authToken}`,
        },
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // 로그아웃 성공 시 돌아가기
          document.getElementById("loginContainer").classList.remove("hidden");
          document
            .getElementById("messageContainer")
            .classList.add("hidden");
          document.getElementById("chat").classList.add("hidden");
          document
            .querySelector(".logout")
            .classList.add("hidden");
          localStorage.removeItem('authToken');
        } else {
          // 로그인 실패 시 에러 메시지 표시
          alert(data.message || "로그아웃 실패");
        }
      })
      .catch((error) => console.error("Error:", error));
    }
  </script>
</html>